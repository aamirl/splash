$(document).on("ready",function(){{var a=$("#messagesTable").data("user"),b=$("#messagesTable").data("seller"),c=s_lang.manager_messages,d=1;$("#messagesTable").dataTable(Sellyx.dt.init({columns:[{orderable:!1,data:null,defaultContent:'<i class="fa fa-lg fa-plus-circle child-details-control"></i>',"class":"center"},{orderable:!1,data:null,defaultContent:'<i class="fa fa-star s-d-yellow"></i>',"class":"center"},{title:c.tables.box.columns.users,data:"users","class":"center",render:function(a){var b="";return $.each(a,function(a,c){1==c.active&&(b+='<a target="_blank" href="/world/'+(1==c.type?"user":"seller")+"/"+c.id+'">'+c.name+"</a><br/>")}),b}},{title:c.tables.box.columns.priority,data:"messages","class":"center",render:function(a){return a[a.length-1].priority}},{title:c.tables.box.columns.last.user,data:"messages","class":"center",render:function(a,b,c){return'<a target="_blank" href="/world/'+(1==c.users[a[a.length-1].user].type?"user":"seller")+"/"+c.users[a[a.length-1].user].id+'">'+c.users[a[a.length-1].user].name+"</a><br/>"}},{title:c.tables.box.columns.last.subject,data:"messages","class":"center",render:function(a){return a[a.length-1].subject?a[a.length-1].subject:"No Subject"}},{title:c.tables.box.columns.last.sent,data:"messages","class":"center",render:function(a){return a[a.length-1].added}},{title:c.tables.box.columns.actions,orderable:!1,data:"messages",render:function(){return console.log(d),'<button class="btn btn-d-red i-btn delete-message-button"><i class="fa fa-trash fa-fw"></i></button>'+(3==d||4==d?'<button class="btn btn-blue i-btn recover-message-button"><i class="fa fa-reply fa-fw"></i></button>':"")},"class":"center"}],order:[[2,"desc"]],ajax:{path:"box",dataSrc:"success"},rowCallback:function(c,d){var e=Sellyx.utility.array.find.object(d.users,"id",a,!1);if(e)e.read||(d.unread=!0,$(c).addClass("row-primary"));else{var e=Sellyx.utility.array.find.object(d.users,"id",b,!1);e.read||(d.unread=!0,$(c).addClass("row-primary"))}}}))}$(document).on("click",".box-button",function(){d=$(this).data("box"),$("#table_title").html($(this).html().replaceAll("fa-li","")),Sellyx.ajax.standard({url:"box",data:"&type="+d,success:function(a){$("#messagesTable").DataTable().clear().rows.add(a).draw()}})}).on("click","#messagesTable tbody > tr.odd , #messagesTable tbody > tr.even",function(a){a.stopImmediatePropagation();var b=Sellyx.row.data($(this)),c=b.data,e=c.messages.length-1;c.unread&&(Sellyx.ajax.standard({url:"read",data:"&id="+c.id+"&type="+d}),c.unread=!1,$(this).removeClass("row-primary"));var f='<div style="padding:10px;background-color:#1b1b1b;color:#FFF;margin-top:-5px;">'+c.messages[e].message+"</div>";if((1==d||2==d)&&(f+='<div style="padding:10px;background-color:beige;margin-top:13px;" class="message-box"><h6><i class="fa fa-fw fa-edit s-d-blue"></i> New Message</h6><div class="input-group" style="margin-top:15px;" ><input class="send form-control" data-var="subject" placeholder="Subject (optional)"/><span class="input-group-addon"><select class="send validate" data-var="priority" ><option value="1">Regular</option><option value="2">Elevated</option><option value="3">Urgent</option><option value="4">Extremely Urgent</option></select></span></div><textarea class="form-control send validate" placeholder="Message" data-var="message"></textarea><div class="buttons-container"><button class="btn fw btn-green send-reply-button"><i class="fa fa-fw fa-envelope"></i> Send</button></div></div>'),e>0)for(f+='<h6><i class="fa fa-fw fa-clock-o s-d-blue"></i> Thread History</h6>';e--;){var g=c.messages[e];f+='<div class="media"><div class="media-left media-middle"><a href="#"><div class="sellyx-thumbnail"><img class="media-object" src="/resources/'+(1==c.users[g.user].type?"users":"sellers")+"/main/small/"+c.users[g.user].id+'.jpg" alt=""></div></a></div><div class="media-body inverted" style="width:100%;padding:10px;"><div class="pull-right" style="color:grey"><span>'+g.added+'</span></div><div><i class="fa fa-fw fa-user s-l-red"></i><a target="_blank" href="/world/'+(1==c.users[g.user].type?"user":"seller")+"/"+c.users[g.user].id+'">'+c.users[g.user].name+"</a> <span> | "+g.subject+'</span><br/><small class="s-d-yellow" style="text-transform:uppercase;">'+g.priority+'</small></div><div><p style="margin-top:20px;border-top:1px solid #DDD; padding-top:10px;">'+g.message+"</p></div></div></div>"}else f+='<h6 style="border:0;padding-bottom:0px;">No Other Messages</h6>';Sellyx.dt.child({all:b,ins:f})}).on("click",".send-reply-button",function(a){a.stopImmediatePropagation();var b=Sellyx.row.data($(this));Sellyx.ajax.standard({url:"reply",container:{divs:$(this).parents(".message-box"),html:"data-var"},button:$(this),data:"&id="+b.data.id,update:{row:b.row,child:!0}})}).on("click",".delete-message-button",function(a){a.stopImmediatePropagation();var b=Sellyx.row.data($(this));Sellyx.ajax.standard({url:"delete",lang:1==d||2==d?c.ajax.delete.trash:c.ajax.delete.forever,button:$(this),data:"&id="+b.data.id+"&type="+d,update:{row:b.row,remove:!0}})}).on("click",".recover-message-button",function(a){a.stopImmediatePropagation();var b=Sellyx.row.data($(this));Sellyx.ajax.standard({url:"recover",button:$(this),data:"&id="+b.data.id+"&type="+d,update:{row:b.row,remove:!0}})}).on("click",".new-message-button",function(){$("#messageModal").modal("show")}).on("click","#messageModal .send-button",function(){Sellyx.ajax.standard({url:"/manager/messages/send",button:$(this),container:{divs:$("#messageModal"),html:"data-var"},success:function(){2==$('select[data-var="as"]').val()?$('.box-button[data-box="2"]').click():$('.box-button[data-box="1"]').click()}})}),$('select[data-var="recipients"]').select2({width:"100%",ajax:{url:"/manager/messages/search",type:"POST",dataType:"json",delay:250,minimumInputLength:3,data:function(a){return{q:a.term}},processResults:function(a){return{results:a}},cache:!0,failure:function(){return!1}}})});